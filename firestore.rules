rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Auth Helpers
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Admin Helper (Email-based for continuity, Plan to migrate to Custom Claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'luisedugusmao@gmail.com';
    }

    match /artifacts/{appId}/public/data {
      
      // STUDENTS: High Security
      match /students/{studentId} {
        allow read: if isAuthenticated();
        
        // Create: Must be role 'student' and default subscription (or free)
        allow create: if isOwner(studentId) 
                      && request.resource.data.role == 'student'
                      && (
                        !('subscription' in request.resource.data) || 
                        request.resource.data.subscription.planId == 'free'
                      );
                      
        // Update: User can edit profile/inventory, BUT NOT role or subscription
        allow update: if isAdmin() || (
                        isOwner(studentId)
                        // Guard ROLE
                        && (
                          !('role' in request.resource.data) || 
                          request.resource.data.role == resource.data.role
                        )
                        // Guard SUBSCRIPTION (Backend only)
                        && (
                          !('subscription' in request.resource.data) || 
                          request.resource.data.subscription == resource.data.subscription
                        )
                        // Guard COINS (Optional: prevents infinite money hack via console)
                        // We might want to allow coin deduction for store purchases though? 
                        // If logic is client-side, we must allow. If server-side, block.
                        // Current Store.jsx logic is client-side. We leave coins open for now 
                        // but ideally should move Store to backend too.
                      );
                      
        allow delete: if isAdmin();
      }
      
      // CLASSES
      match /classes/{classId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin(); 
      }
      
      // QUIZZES
      match /quizzes/{quizId} {
        allow read: if isAuthenticated();
        // User tracking (completion arrays) requires update access
        // Ideally we'd restrict allowing ONLY adding self to 'completedBy'
        allow update: if isAuthenticated(); 
        allow create, delete: if isAdmin();
      }

      // FEED
      match /feed/{feedId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      }

      // CHANNELS
      match /channels/{channelId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }

      // NOTIFICATIONS
      match /notifications/{notificationId} {
        allow read, update, delete: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
        allow create: if isAdmin() || (isAuthenticated() && request.resource.data.recipientId == request.auth.uid);
      }
    }
  }
}
