rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    

    // Helper function to check if the user is an admin (based on email)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.email == 'luisedugusmao@gmail.com';
    }

    match /artifacts/{appId}/public/data {
      
      // STUDENTS COLLECTION
      match /students/{studentId} {
        // Read: Allow any authenticated user to read students (for Leaderboard/Ranking)
        allow read: if isAuthenticated();
        
        // Write: Only the owner can write to their own document.
        allow create: if isOwner(studentId) 
                      && request.resource.data.role == 'student';
                      
        allow update: if isOwner(studentId)
                      && (
                        !('role' in request.resource.data) || 
                        request.resource.data.role == resource.data.role
                      ) || isAdmin(); // Admin can update students (e.g. promote/demote or edit details)
                      
        // Delete: Only owner or admin
        allow delete: if isOwner(studentId) || isAdmin();
      }
      
      // CLASSES COLLECTION
      match /classes/{classId} {
        // Read: All authenticated students
        allow read: if isAuthenticated();
        // Write: Only Admins
        allow write: if isAdmin(); 
      }
      
      // QUIZZES COLLECTION
      match /quizzes/{quizId} {
        allow read: if isAuthenticated();
        // Allow updates if authenticated (User completion tracking) OR Admin
        allow update: if isAuthenticated(); 
        allow create, delete: if isAdmin();
      }

      // FEED COLLECTION
      match /feed/{feedId} {
        allow read: if isAuthenticated();
        // Allow create for any auth user (Chat + Activity Broadcasts)
        allow create: if isAuthenticated();
        // Only admin can update/delete (moderation) - or user can delete own?
        allow update, delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      }

      // CHANNELS COLLECTION
      match /channels/{channelId} {
        allow read: if isAuthenticated();
        // Only Admin can create/update/delete channels
        allow write: if isAdmin();
      }

      // NOTIFICATIONS COLLECTION
      match /notifications/{notificationId} {
        // Users can read/delete their own notifications
        allow read, update, delete: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
        // Admins can create notifications, OR users can create for themselves (local reminders sync)
        allow create: if isAdmin() || (isAuthenticated() && request.resource.data.recipientId == request.auth.uid);
      }
    }
  }
}
